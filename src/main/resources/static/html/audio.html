<!DOCTYPE html>

<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>语音录制示例</title>
  <style type='text/css'>
    ul { list-style: none; }
    #recordingslist audio { display: block; margin-bottom: 10px; }
  </style>
</head>
<body>

  <h1>Recorder.js 录制pcm音频格式示例</h1>

  <p>Make sure you are using a recent version of Google Chrome.</p>
  <p>Also before you enable microphone input either plug in headphones or turn the volume down if you want to avoid ear splitting feedback!</p>

  <button onclick="startRecording(this);">录音</button>
  <button onclick="stopRecording(this);" disabled>停止</button>
  <button onclick="uploadRecording(this);" disabled>上传</button>
  
  <h2>Recordings</h2>
  <ul id="recordingslist"></ul>
  
  <h2>Log</h2>
  <pre id="log"></pre>

  <script>
  function __log(e, data) {
    log.innerHTML += "\n" + e + " " + (data || '');
  }

  var audio_context;
  var recorder;
  //初始化设备
  function startUserMedia(stream) {
    var input = audio_context.createMediaStreamSource(stream);
    __log('Media stream created.');

    // Uncomment if you want the audio to feedback directly
    //input.connect(audio_context.destination);
    //__log('Input connected to audio context destination.');
  
    recorder = new HZRecorder(stream);
    __log('Recorder initialised.');
  }
  //开始录制
  function startRecording(button) {
    recorder && recorder.start();
    button.disabled = true;
    button.nextElementSibling.disabled = false;
    button.nextElementSibling.nextElementSibling.disabled = true;
    __log('Recording...');
  }
  //停止录制	
  function stopRecording(button) {
    recorder && recorder.stop();
    button.disabled = true;
    button.previousElementSibling.disabled = false;
    button.nextElementSibling.disabled = false;
    __log('Stopped recording.');
    
    // create WAV download link using audio data blob
    createDownloadLink();
  }

  //上传
  function uploadRecording(button){
    button.disabled = true;
    recorder.upload("/audio/save", function (state, e) {
      switch (state) {
          case 'uploading':
              //var percentComplete = Math.round(e.loaded * 100 / e.total) + '%';
              break;
          case 'ok':
              alert(e.target.responseText);
             // alert("上传成功");
              //清空缓存
              recorder.clear();
              break;
          case 'error':
              alert("上传失败");
              break;
          case 'cancel':
              alert("上传被取消");
              break;
      }
  });
  }
  //创建wav下载链接
  function createDownloadLink() {
    var url = URL.createObjectURL(recorder.getBlob());
	var li = document.createElement('li');
    var au = document.createElement('audio');
    var hf = document.createElement('a');

    au.controls = true;
    au.src = url;
    hf.href = url;
    hf.download = new Date().toISOString() + '.wav';
    hf.innerHTML = hf.download;
    li.appendChild(au);
    li.appendChild(hf);
    recordingslist.appendChild(li);
  }

  window.onload = function init() {
    try {
      // webkit shim
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
      window.URL = window.URL || window.webkitURL;
      
      audio_context = new AudioContext;
      __log('Audio context set up.');
      __log('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
    } catch (e) {
      alert('No web audio support in this browser!');
    }
    
    navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
      __log('No live audio input: ' + e);
    });
  };
  </script>

  <script type="text/javascript" src="../js/HZRecorder.js"></script>
</body>
</html>
